<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>🌟大學星生活🌟刮刮卡</title>
<style>
  body { margin:0; padding:0; font-family:Arial,sans-serif; background:#f8f8f8; text-align:center; }
  h1 { margin:15px 0; color:#333; font-size:clamp(20px,5vw,32px); }
  #wrapper { position:relative; display:inline-block; width:95vw; max-width:400px; margin:auto; }
  canvas { border:2px solid #ccc; border-radius:12px; display:block; width:100%; height:auto; }
  #result { margin-top:15px; font-size:clamp(16px,4vw,22px); color:#333; font-weight:bold; display:none; }
  .prize { font-size:clamp(24px,6vw,40px); font-weight:700; color:#c00; margin-bottom:6px; white-space:nowrap; }
  .notice { font-size:clamp(14px,3.5vw,18px); color:#e60000; font-weight:500; }
</style>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<h1>🌟大學星生活🌟</h1>
<div id="wrapper">
  <canvas id="bgCanvas"></canvas>
  <canvas id="maskCanvas" style="position:absolute;top:0;left:0;"></canvas>
</div>
<div id="result">刮開看看你的獎項！</div>

<script>
// ===== 型號對照表 =====
const modelMap = {
  // iPhone 16 系列
  "IPHONE17,3": "iPhone 16",
  "IPHONE17,4": "iPhone 16 Plus",
  "IPHONE17,1": "iPhone 16 Pro",
  "IPHONE17,2": "iPhone 16 Pro Max",
  "IPHONE17,5": "iPhone 16e",

  // iPhone 15 系列
  "IPHONE16,1": "iPhone 15 Pro",
  "IPHONE16,2": "iPhone 15 Pro Max",
  "IPHONE15,4": "iPhone 15",
  "IPHONE15,5": "iPhone 15 Plus",
  
  // iPhone 14 系列
  "IPHONE15,2": "iPhone 14 Pro",
  "IPHONE15,3": "iPhone 14 Pro Max",
  "IPHONE14,7": "iPhone 14",
  "IPHONE14,8": "iPhone 14 Plus",
  "IPHONE14,2": "iPhone 13 Pro",
  "IPHONE14,3": "iPhone 13 Pro Max",
  "IPHONE14,4": "iPhone 13 mini",
  "IPHONE14,5": "iPhone 13",
  "IPHONE13,1": "iPhone 12 mini",
  "IPHONE13,2": "iPhone 12",
  "IPHONE13,3": "iPhone 12 Pro",
  "IPHONE13,4": "iPhone 12 Pro Max",
  "IPHONE12,1": "iPhone 11",
  "IPHONE12,3": "iPhone 11 Pro",
  "IPHONE12,5": "iPhone 11 Pro Max",
  "IPHONE11,2": "iPhone XS",
  "IPHONE11,4": "iPhone XS Max",
  "IPHONE11,6": "iPhone XS Max",
  "IPHONE11,8": "iPhone XR",
  "IPHONE10,3": "iPhone X",
  "IPHONE10,6": "iPhone X",
  "IPHONE14,6": "iPhone SE (第3代)",
  "IPHONE12,8": "iPhone SE (第2代)",
  "IPHONE8,4": "iPhone SE (第1代)",


  // 其他品牌...
  "SM-G9800": "Galaxy S20","SM-G9860": "Galaxy S20+","SM-G9880": "Galaxy S20 Ultra",
  "SM-G9910": "Galaxy S21","SM-G9960": "Galaxy S21+","SM-G9980": "Galaxy S21 Ultra",
  "SM-S9010": "Galaxy S22","SM-S9060": "Galaxy S22+","SM-S9080": "Galaxy S22 Ultra",
  "SM-S9110": "Galaxy S23","SM-S9160": "Galaxy S23+","SM-S9180": "Galaxy S23 Ultra",
  "SM-S9210": "Galaxy S24","SM-S9260": "Galaxy S24+","SM-S9280": "Galaxy S24 Ultra",
  "SM-S9310": "Galaxy S25","SM-S9360": "Galaxy S25+","SM-S9380": "Galaxy S25 Ultra",
  "SM-F7000": "Galaxy Z Flip","SM-F9160": "Galaxy Z Fold2","SM-F7110": "Galaxy Z Flip3",
  "SM-F9260": "Galaxy Z Fold3","SM-F7210": "Galaxy Z Flip4","SM-F9360": "Galaxy Z Fold4",
  "SM-F7310": "Galaxy Z Flip5","SM-F9460": "Galaxy Z Fold5","SM-F7410": "Galaxy Z Flip6",
  "SM-F9560": "Galaxy Z Fold6","SM-A5150": "Galaxy A51","SM-A7150": "Galaxy A71",
  "SM-A3250": "Galaxy A32","SM-A5250": "Galaxy A52","SM-A5260": "Galaxy A52 5G",
  "SM-A7250": "Galaxy A72","SM-A2660": "Galaxy A26 5G","SM-A3360": "Galaxy A33 5G",
  "SM-A3660": "Galaxy A36 5G","SM-A5360": "Galaxy A53 5G","SM-A5660": "Galaxy A56 5G",
  "SM-A7360": "Galaxy A73 5G","SM-A1460": "Galaxy A14 5G","SM-A2450": "Galaxy A24",
  "SM-A3460": "Galaxy A34 5G","SM-A5460": "Galaxy A54 5G","SM-A3560": "Galaxy A35 5G",
  "SM-A5560": "Galaxy A55 5G","SM-A1660": "Galaxy A16",
  "iPhone": "Apple iPhone（型號未知）",
  "Pixel 7": "Google Pixel 7","Pixel 7 Pro": "Google Pixel 7 Pro",
  "Pixel 8": "Google Pixel 8","Pixel 8 Pro": "Google Pixel 8 Pro",
  "Pixel 9": "Google Pixel 9","Pixel 9 Pro": "Google Pixel 9 Pro",
  "OnePlus 9": "OnePlus 9","OnePlus 10": "OnePlus 10","OnePlus 11": "OnePlus Buds",
  "OnePlus 13": "OnePlus 13","XQ-DC72": "Sony Xperia 1 V","XQ-DQ72": "Sony Xperia 5 V",
  "23078PND5G": "Xiaomi 13T Pro","22071212AG": "Xiaomi 12T Pro",
  "23021RAA2Y": "Redmi Note 12","23090RA98G": "Redmi Note 13 Pro",
  "AI2205": "ASUS ROG Phone 6","AI2401": "ASUS ROG Phone 8","AI2302": "ASUS Zenfone 10",
  "CPH2491": "OPPO Reno10","CPH2525": "OPPO Find X6",
  "V2238": "vivo X90","V2303": "vivo Y78","RMX3820": "realme 11 Pro+","RMX3866": "realme GT Neo5"
};

function guessModelName(rawModel) {
  if (!rawModel) return "未知機型";
  const key = rawModel.toUpperCase();
  
  if (modelMap[key]) return modelMap[key];

  if (key.includes("IPHONE")) return "Apple iPhone（型號未知）";

  if (key.startsWith("SM-A")) return "Samsung Galaxy A 系列 " + rawModel;
  if (key.startsWith("SM-S")) return "Samsung Galaxy S 系列 " + rawModel;
  if (key.startsWith("SM-F")) return "Samsung Galaxy Z 系列 " + rawModel;
  if (key.includes("PIXEL")) return rawModel;
  if (key.includes("ONEPLUS")) return rawModel;
  if (key.includes("OPPO")) return rawModel;
  if (key.includes("ASUS")) return rawModel;
  if (key.includes("VIVO")) return rawModel;
  if (key.includes("REALME")) return rawModel;
  if (key.includes("XIAOMI") || key.includes("REDMI")) return "Xiaomi";
  return rawModel;
}

function detectBrand(modelCode) {
  const code = modelCode.toUpperCase();
  if (code.startsWith("SM-")) return "Samsung";
  if (code.includes("IPHONE")) return "Apple";
  if (code.includes("PIXEL")) return "Google";
  if (code.includes("ONEPLUS")) return "OnePlus";
  if (code.includes("OPPO")) return "OPPO";
  if (code.includes("ASUS")) return "ASUS";
  if (code.includes("VIVO")) return "vivo";
  if (code.includes("REALME")) return "realme";
  if (code.includes("XIAOMI") || code.includes("REDMI")) return "Xiaomi";
  return "Android";
}

function getAndroidModel(ua) {
  const regex = /android.*;\s([^;]+)\sbuild/i;
  let match = ua.match(regex);
  if (match && match[1]) {
    let model = match[1].trim();
    if (model.toLowerCase() === 'wv') return "Android裝置";
    return model;
  }
  const regex2 = /android.*;\s([^;]+)\)/i;
  match = ua.match(regex2);
  if (match && match[1]) {
    let model = match[1].trim();
    if (model.toLowerCase() === 'wv') return "Android裝置";
    return model;
  }
  return "Android裝置";
}

// ===== Firebase 設定 =====
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://guaguaca-4396a-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== LIFF 設定 =====
const LIFF_ID = '2007597530-o1xaVbZm';

// ===== DOM =====
const wrapper = document.getElementById('wrapper');
const bgCanvas = document.getElementById('bgCanvas');
const maskCanvas = document.getElementById('maskCanvas');
const bgCtx = bgCanvas.getContext('2d');
const maskCtx = maskCanvas.getContext('2d');
const resultDiv = document.getElementById('result');

let deviceBrand = '未知';
let deviceModel = '未知';
let userId = '未知';
let prize = '';
let singleDraw = false;
let resultShown = false;

// ===== 圖片設定 =====
const images = {
  '天選獎S1':'https://i.postimg.cc/RCGKq4nk/6.png',
  '天選獎S2':'https://i.postimg.cc/gkxjRNkf/5.png',
  '機會獎':'https://i.postimg.cc/3xpwfNG1/3.png',
  '命運獎':'https://i.postimg.cc/RFCV0TDp/2.png'
};

// ===== 型號偵測 =====
function getDeviceInfo(){
  const ua=navigator.userAgent.toLowerCase();
  if(ua.includes('iphone')){ deviceBrand='Apple'; deviceModel=guessModelName(ua.match(/iphone\d+,\d+/i)?.[0]); }
  else if(ua.includes('ipad')){ deviceBrand='Apple'; deviceModel='iPad'; }
  else if(ua.includes('android')){
    const model = getAndroidModel(ua);
    deviceModel = guessModelName(model);
    deviceBrand = detectBrand(model);
  }
  else{ deviceBrand='未知'; deviceModel='未知'; }
}

// ===== 讀取後台設定 =====
async function fetchSettings(){
  try {
    const snapshot = await db.ref('settings/singleDraw').get();
    if(snapshot.exists()){
      singleDraw = snapshot.val() === true;
    }
  } catch(e){
    console.error('讀取設定失敗', e);
  }
}

// ===== LIFF 初始化 =====
async function initLiff(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) liff.login();
  else{
    try{ 
      const profile=await liff.getProfile(); 
      userId=profile.userId||'未知'; 
    } catch(err){ console.error('無法取得使用者ID',err);}
    
    getDeviceInfo();
    await fetchSettings();
    await checkRecordAndDraw();
  }
}

// ===== 檢查抽獎紀錄與執行抽獎 =====
async function checkRecordAndDraw() {
  if (singleDraw) {
    const recordSnap = await db.ref('lottery-records/' + userId).get();
    if (recordSnap.exists()) {
      const recordedPrize = recordSnap.val().prize;
      // 在此處呼叫 showResult，並傳入已知的獎項名稱
      showResult(recordedPrize, true); 
      return;
    }
  }
  await drawLottery();
}

// ===== 抽獎邏輯 =====
async function drawLottery(){
  try {
    const quotasRef = db.ref('lottery-quotas');
    const quotasSnap = await quotasRef.get();
    const quotas = quotasSnap.val();

    // 在此處將 prize 變數賦予一個預設值，確保它總是有值
    prize = '';

    const rand = Math.random();
    if (rand < 1/303) {
      const rarePrizes = ['天選獎S1', '天選獎S2'];
      const shuffledPrizes = rarePrizes.sort(() => 0.5 - Math.random());
      
      for (const p of shuffledPrizes) {
        if (quotas[p] > 0) {
          prize = p;
          break;
        }
      }
    }

    if (!prize) {
      let normalPrizes = [];
      if (quotas['機會獎'] > 0) normalPrizes.push('機會獎');
      if (quotas['命運獎'] > 0) normalPrizes.push('命運獎');
      
      if (normalPrizes.length > 0) {
        prize = normalPrizes[Math.floor(Math.random() * normalPrizes.length)];
      } else {
        prize = '機會獎';
      }
    }

    if (prize) {
      const quotaRef = db.ref('lottery-quotas/' + prize);
      quotaRef.transaction(current => {
        if (current > 0) {
          return current - 1;
        } else {
          return 0;
        }
      }, (error, committed) => {
        if (error) {
          console.error('更新配額失敗', error);
        } else if (committed) {
          db.ref('lottery-records/' + userId).set({
            prize: prize,
            timestamp: Date.now()
          });
        }
      });
    }

    const statRef = db.ref(`lottery-stats/${deviceBrand}/${deviceModel}`);
    statRef.transaction(current => (current||0)+1);

    img.src = images[prize] || images['機會獎'];

  } catch(e) {
    console.error('抽獎或 Firebase 互動失敗', e);
    prize='機會獎';
    img.src = images[prize];
  }
}

// ===== 畫布設定 =====
function setCanvasSize(){
  const width = wrapper.clientWidth;
  const height = Math.floor(width*1350/1080);
  wrapper.style.height = height+'px';
  bgCanvas.width = maskCanvas.width = width;
  bgCanvas.height = maskCanvas.height = height;
}

function initMask(){
  maskCtx.fillStyle='#999';
  maskCtx.fillRect(0,0,maskCanvas.width,maskCanvas.height);
}

// ===== 刮刮卡 =====
let isDrawing=false;
function getPos(e){
  const rect=maskCanvas.getBoundingClientRect();
  if(e.touches && e.touches.length>0) return {x:e.touches[0].clientX-rect.left, y:e.touches[0].clientY-rect.top};
  else return {x:e.clientX-rect.left, y:e.clientY-rect.top};
}

function scratch(e){
  if(!isDrawing || resultShown) return;
  e.preventDefault();
  const {x,y}=getPos(e);
  maskCtx.globalCompositeOperation='destination-out';
  maskCtx.beginPath();
  maskCtx.arc(x,y,50,0,Math.PI*2);
  maskCtx.fill();
}

function checkScratchPercent(){
  if(resultShown) return;
  const imgData=maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height).data;
  let cleared=0;
  for(let i=3;i<imgData.length;i+=4) if(imgData[i]===0) cleared++;
  if(cleared/(maskCanvas.width*maskCanvas.height) > 0.5) {
    // 這裡改為直接呼叫 showResult，因為 drawLottery 已確保 prize 有值
    showResult(prize, false);
    resultShown = true;
  }
}

function showResult(prizeText, repeated = false){
  if(repeated){
    wrapper.style.display = 'none';
    resultDiv.innerHTML = `<div class="prize">已抽過 🎉 ${prizeText} 🎉</div>
      <div class="notice">請洽服務人員兌獎</div>`;
  } else {
    resultDiv.innerHTML = `<div class="prize">恭喜抽中🎉 ${prizeText} 🎉</div>
      <div class="notice">請洽服務人員兌獎</div>`;
  }
  resultDiv.style.display='block';
  maskCanvas.style.pointerEvents='none';
}

// ===== 綁定事件 =====
maskCanvas.addEventListener('mousedown',e=>{isDrawing=true;scratch(e);});
maskCanvas.addEventListener('mousemove',scratch);
maskCanvas.addEventListener('mouseup',()=>{isDrawing=false; checkScratchPercent();});
maskCanvas.addEventListener('mouseleave',()=>{isDrawing=false;});
maskCanvas.addEventListener('touchstart',e=>{isDrawing=true;scratch(e);},{passive:false});
maskCanvas.addEventListener('touchmove',scratch,{passive:false});
maskCanvas.addEventListener('touchend',()=>{isDrawing=false; checkScratchPercent();});

// ===== 載入圖片 =====
const img=new Image();
img.crossOrigin='anonymous';
img.onload=()=>{
  setCanvasSize();
  bgCtx.drawImage(img,0,0,bgCanvas.width,bgCanvas.height);
  initMask();
};
window.addEventListener('resize',()=>{
  setCanvasSize();
  bgCtx.drawImage(img,0,0,bgCanvas.width,bgCanvas.height);
  initMask();
});

// ===== 初始化 =====
initLiff();
</script>
</body>
</html>
